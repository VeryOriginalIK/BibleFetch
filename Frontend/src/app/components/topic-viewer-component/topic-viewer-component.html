<!-- Close picker on backdrop click -->
@if (collectionPickerVerseId()) {
  <div class="fixed inset-0 z-30" (click)="closeCollectionPicker()"></div>
}

@if (vm$ | async; as vm) {
  <div class="topic-viewer">
    <header class="topic-hero" [style.background-color]="vm.topic.theme_color">
      <div class="hero-content">
        <a routerLink="/" class="back-btn">← Vissza</a>
        <h1>{{ vm.topic.titles.hu }}</h1>
        @if (vm.topic.description) {
          <p>{{ vm.topic.description.hu }}</p>
        }
      </div>
    </header>

    <div class="verses-container">
      @for (verse of vm.verses; track verse.label) {
        <div class="verse-card relative">

          <!-- Verse header row -->
          <div class="flex items-center justify-between mb-1">

            <!-- Clickable verse reference → navigate to bible reader -->
            <button
              (click)="navigateToVerse(verse.bookId, verse.chapter)"
              class="verse-ref text-left hover:underline focus:outline-none"
              [style.color]="vm.topic.theme_color"
              title="Ugrás a bibliaolvasóba"
            >
              {{ verse.label }}
            </button>

            <!-- Bookmark / collection picker button -->
            <div class="relative">
              <button
                (click)="openCollectionPicker(verse.verseId, $event)"
                class="p-1.5 rounded-lg transition-colors opacity-60 hover:opacity-100"
                [class.text-amber-500]="collectionService.isVerseInAnyCollection(verse.verseId)"
                [class.text-gray-400]="!collectionService.isVerseInAnyCollection(verse.verseId)"
                title="Gyűjteményhez adás"
              >
                @if (collectionService.isVerseInAnyCollection(verse.verseId)) {
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                  </svg>
                } @else {
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                  </svg>
                }
              </button>

              <!-- Collection picker dropdown -->
              @if (collectionPickerVerseId() === verse.verseId) {
                <div
                  class="absolute right-0 top-9 z-40 w-64 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden"
                  (click)="$event.stopPropagation()"
                >
                  <div class="px-3 py-2 border-b border-gray-100 dark:border-gray-700">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Gyűjtemények</p>
                  </div>

                  <div class="max-h-48 overflow-y-auto">
                    @for (col of collectionService.collections(); track col.id) {
                      <button
                        (click)="toggleVerseInCollection(col.id, verse.verseId, $event)"
                        class="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors text-left"
                      >
                        <span class="w-5 h-5 flex items-center justify-center rounded border shrink-0 transition-colors"
                              [class]="collectionService.isVerseInCollection(col.id, verse.verseId)
                                ? 'bg-blue-600 border-blue-600 text-white'
                                : 'border-gray-300 dark:border-gray-600'">
                          @if (collectionService.isVerseInCollection(col.id, verse.verseId)) {
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                            </svg>
                          }
                        </span>
                        <span class="truncate">{{ col.name }}</span>
                        <span class="ml-auto text-xs text-gray-400">{{ col.verse_ids.length }}</span>
                      </button>
                    } @empty {
                      <p class="text-xs text-gray-400 text-center py-3 px-3">Még nincs gyűjtemény.<br>Hozz létre egyet lent.</p>
                    }
                  </div>

                  <!-- Create new collection -->
                  <div class="border-t border-gray-100 dark:border-gray-700 px-3 py-2">
                    <div class="flex items-center gap-2">
                      <input
                        type="text"
                        [value]="newCollectionName()"
                        (input)="newCollectionName.set($any($event.target).value)"
                        (keydown.enter)="createAndAddToCollection(verse.verseId)"
                        placeholder="Új gyűjtemény..."
                        class="flex-1 text-sm px-2 py-1.5 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        (click)="$event.stopPropagation()"
                      />
                      <button
                        (click)="createAndAddToCollection(verse.verseId)"
                        [disabled]="!newCollectionName().trim()"
                        class="p-1.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed transition-colors shrink-0"
                      >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <app-verse-renderer [rawText]="verse.text"></app-verse-renderer>
        </div>
      }
    </div>
  </div>
} @else {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Téma betöltése...</p>
  </div>
}

